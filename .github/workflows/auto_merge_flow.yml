name: Auto-merge bot flow

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review

permissions:
  contents: write
  pull-requests: write

jobs:
  automerge:
    runs-on: ubuntu-latest

    # Only Dependabot and Snyk PRs
    if: >
      github.event.pull_request.user.login == 'dependabot[bot]' ||
      github.event.pull_request.user.login == 'snyk-bot'

    steps:
      - name: Cool-off period (wait 5 minutes)
        run: sleep 300

      - name: Comment and proceed with auto-merge
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pr = context.payload.pull_request;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr.number,
              body: [
                '‚è≥ **Auto-merge initiated after cool-off period**',
                '',
                'No additional checks were evaluated by the bot.',
                'GitHub branch protection rules will decide final merge eligibility.',
                '',
                'Proceeding with auto-merge.'
              ].join('\n')
            });

      - name: Enable auto-merge via GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge "${{ github.event.pull_request.number }}" \
            --auto \
            --squash
