name: Auto-merge bot flow

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  automerge:
    runs-on: ubuntu-latest
    if: >
      github.event.pull_request.user.login == 'dependabot[bot]' ||
      github.event.pull_request.user.login == 'snyk-bot'

    steps:
      - name: Wait for required checks + policy validation
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pr = context.payload.pull_request;
            const sha = pr.head.sha;

            const REQUIRED_CHECKS = [
              'adminvns.testapi',
              'Codacy Static Code Analysis',
              'security/snyk (webnesters)'
            ];

            // ---- wait loop (max ~5 min) ----
            for (let i = 0; i < 30; i++) {
              const { data } = await github.rest.checks.listForRef({
                owner,
                repo,
                ref: sha
              });

              const completed = data.check_runs.filter(
                c => REQUIRED_CHECKS.includes(c.name)
              );

              const allDone =
                completed.length === REQUIRED_CHECKS.length &&
                completed.every(c => c.conclusion === 'success');

              if (allDone) break;

              if (i === 29) {
                core.setFailed('Required checks did not complete successfully in time');
              }

              await new Promise(r => setTimeout(r, 10000));
            }

            // ---- policy rules ----
            if (pr.changed_files > 5) {
              core.setFailed(`Too many files changed (${pr.changed_files})`);
            }

            if (/\b(major|minor|fix)\b/i.test(pr.title)) {
              core.setFailed(`Blocked by title rule: ${pr.title}`);
            }

      - name: Enable auto-merge via GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge "${{ github.event.pull_request.number }}" \
            --auto \
            --squash
